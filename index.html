<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>양도세 챗봇</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* API 설정 모달 */
        .api-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .api-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-width: 500px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .api-content h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .api-form {
            margin-bottom: 30px;
        }

        .api-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .api-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .api-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .api-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .api-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .login-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            font-size: 14px;
        }

        .success-message {
            color: #27ae60;
            margin-top: 15px;
            font-size: 14px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
            border-radius: 20px 20px 0 0;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .api-settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .api-settings-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .n8n-status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-light {
            width: 8px;
            height: 8px;
            background: #00ff00;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .messages {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 25px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .message-content {
            max-width: 75%;
            padding: 20px 25px;
            border-radius: 25px;
            line-height: 1.6;
            font-size: 15px;
            word-wrap: break-word;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 8px;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-bottom-right-radius: 8px;
        }

        /* 메시지 액션 버튼들 */
        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            align-items: center;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.2s ease;
            font-size: 14px;
            color: #666;
        }

        .action-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .copy-btn {
            color: #667eea;
        }

        .copy-btn:hover {
            background: #e8f0ff;
        }

        .feedback-btn {
            color: #28a745;
        }

        .feedback-btn:hover {
            background: #e8f5e8;
        }

        .feedback-btn.negative {
            color: #dc3545;
        }

        .feedback-btn.negative:hover {
            background: #ffe8e8;
        }

        /* 코멘트 모달 */
        .comment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .comment-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-width: 400px;
            max-width: 500px;
        }

        .comment-content h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .comment-textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 20px;
        }

        .comment-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .comment-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .comment-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .comment-save {
            background: #28a745;
            color: white;
        }

        .comment-save:hover {
            background: #218838;
        }

        .comment-cancel {
            background: #6c757d;
            color: white;
        }

        .comment-cancel:hover {
            background: #5a6268;
        }

        /* 관리자 모드 모달 */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10002;
        }

        .admin-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-width: 600px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .admin-content h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .feedback-list {
            text-align: left;
            margin-top: 20px;
        }

        .feedback-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .feedback-type {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .feedback-type.positive {
            background: #28a745;
        }

        .feedback-type.negative {
            background: #dc3545;
        }

        /* n8n 엔진 제어 섹션 */
        .n8n-control-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
        }

        .n8n-status-display {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .n8n-control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .n8n-control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .n8n-control-btn.n8n-on {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .n8n-control-btn.n8n-on:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            transform: translateY(-2px);
        }

        .n8n-control-btn.n8n-off {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .n8n-control-btn.n8n-off:hover {
            background: linear-gradient(135deg, #c82333 0%, #e8590c 100%);
            transform: translateY(-2px);
        }

        .feedback-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
            text-align: center;
        }

        .feedback-date {
            color: #666;
            font-size: 12px;
        }

        .feedback-question {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .feedback-answer {
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .feedback-comment {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            color: #333;
        }

        .download-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .input-area {
            padding: 25px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-area textarea {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            padding: 15px 25px;
            font-size: 16px;
            resize: none;
            outline: none;
            min-height: 55px;
            max-height: 120px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .input-area textarea:focus {
            border-color: #667eea;
        }

        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stop-button, .restart-button {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            margin-left: 10px;
        }

        .stop-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
        }

        .restart-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .restart-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 80% { content: '...'; }
            100% { content: ''; }
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .welcome-message h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .welcome-message p {
            font-size: 16px;
            line-height: 1.6;
        }

        /* 크롬 전용 스타일 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .chat-container {
                height: 95vh;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
                border-radius: 15px 15px 0 0;
            }
            
            .header h1 {
                font-size: 24px;
            }

            .n8n-status {
                font-size: 11px;
                padding: 6px 12px;
            }

            .api-settings-btn {
                font-size: 11px;
                padding: 6px 12px;
            }
            
            .messages {
                padding: 20px;
            }
            
            .message-content {
                max-width: 85%;
                padding: 15px 20px;
                font-size: 14px;
            }
            
            .input-area {
                padding: 20px;
                gap: 12px;
            }
            
            .input-area textarea {
                padding: 12px 20px;
                font-size: 16px;
            }
            
            .send-button {
                width: 50px;
                height: 50px;
                font-size: 18px;
            }

            .api-content {
                min-width: 90%;
                padding: 30px 20px;
            }

            .comment-content,
            .admin-content {
                min-width: 90%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container" id="chatContainer">
        <div class="header">
            <div class="n8n-status">
                <div class="status-light"></div>
                <span id="headerN8nText">n8n 엔진 On</span>
            </div>
            <button class="api-settings-btn" onclick="openApiSettings()">⚙️ API 설정</button>
            <h1>💰 Tax Agent</h1>
            <p>양도소득세 관련 궁금한 점을 물어보세요</p>
        </div>

        <div class="messages" id="messages">
            <div class="welcome-message">
                <h2>안녕하세요! 👋</h2>
                <p>Tax Agent 양도소득세 전문 상담사입니다.<br>
                궁금한 점이 있으시면 언제든 질문해주세요.</p>
            </div>
        </div>

        <div class="input-area">
            <textarea 
                id="messageInput" 
                placeholder="양도세 관련 질문을 입력하세요..."
                rows="1"
            ></textarea>
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                ➤
            </button>
            <button class="stop-button" id="stopButton" onclick="stopResponse()" style="display: none;">
                ⏹️
            </button>
            <button class="restart-button" id="restartButton" onclick="restartResponse()" style="display: none;">
                🔄
            </button>
        </div>
    </div>

    <!-- API 설정 모달 -->
    <div class="api-modal" id="apiModal">
        <div class="api-content">
            <h2>🔧 API 설정</h2>
            
            <!-- 로그인 섹션 -->
            <div id="loginSection">
                <div class="api-form">
                    <input type="text" class="login-input" id="loginId" placeholder="아이디" value="">
                    <input type="password" class="login-input" id="loginPw" placeholder="비밀번호" value="">
                    <button class="login-button" onclick="handleApiLogin()">로그인</button>
                    <div class="error-message" id="loginError"></div>
                </div>
                <button class="api-button" onclick="closeApiSettings()" style="background: #6c757d; margin-top: 15px;">Tax Agent로 돌아가기</button>
            </div>

            <!-- API 설정 섹션 -->
            <div id="apiSettingsSection" style="display: none;">
                <!-- API 입력 -->
                <div class="api-section">
                    <h3>🔧 API 입력</h3>
                    <input type="password" class="api-input" id="apiKey" placeholder="API Key를 입력하세요">
                </div>

                <button class="api-button" onclick="saveApiKeys()">API 키 저장</button>
                <button class="api-button" onclick="closeApiSettings()" style="background: #6c757d; margin-top: 10px;">닫기</button>
                <div class="success-message" id="apiSuccess"></div>
                <div class="error-message" id="apiError"></div>
            </div>
        </div>
    </div>

    <!-- 코멘트 모달 -->
    <div class="comment-modal" id="commentModal">
        <div class="comment-content">
            <h3 id="commentTitle">피드백 코멘트</h3>
            <textarea 
                class="comment-textarea" 
                id="commentText" 
                placeholder="코멘트를 입력해주세요..."
            ></textarea>
            <div class="comment-buttons">
                <button class="comment-btn comment-save" onclick="saveComment()">저장</button>
                <button class="comment-btn comment-cancel" onclick="closeCommentModal()">취소</button>
            </div>
        </div>
    </div>

    <!-- 관리자 모드 모달 -->
    <div class="admin-modal" id="adminModal">
        <div class="admin-content">
            <h3>👨‍💼 관리자 모드</h3>
            
            <!-- AI 모델 선택 섹션 -->
            <div class="n8n-control-section">
                <div class="n8n-status-display">
                    <span style="color: #667eea; font-weight: bold;">🤖 AI 모델 선택</span>
                </div>
                <div class="n8n-control-buttons">
                    <button class="n8n-control-btn n8n-off" onclick="selectModel('sonar')" id="model-sonar-btn">sonar</button>
                    <button class="n8n-control-btn n8n-off" onclick="selectModel('sonar-pro')" id="model-sonar-pro-btn">sonar-pro</button>
                    <button class="n8n-control-btn n8n-off" onclick="selectModel('sonar-reasoning')" id="model-sonar-reasoning-btn">sonar-reasoning</button>
                </div>
                <div class="n8n-control-buttons" style="margin-top: 10px;">
                    <button class="n8n-control-btn n8n-on" onclick="selectModel('sonar-reasoning-pro')" id="model-sonar-reasoning-pro-btn">sonar-reasoning-pro</button>
                    <button class="n8n-control-btn n8n-off" onclick="selectModel('sonar-deep-research')" id="model-sonar-deep-research-btn">sonar-deep-research</button>
                </div>
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                    현재 선택된 모델: <span id="currentModelDisplay" style="font-weight: bold; color: #667eea;">sonar-reasoning-pro</span>
                </div>
                <div style="text-align: center; margin-top: 5px; font-size: 11px; color: #888;">
                    💡 모든 모델은 웹 검색 기능을 포함합니다
                </div>
            </div>
            
            <!-- n8n 엔진 제어 섹션 -->
            <div class="n8n-control-section">
                <div class="n8n-status-display">
                    <div class="status-light" id="adminStatusLight"></div>
                    <span id="n8nStatusText">n8n 엔진 On</span>
                </div>
                <div class="n8n-control-buttons">
                    <button class="n8n-control-btn n8n-on" onclick="toggleN8nEngine('on')">n8n 엔진 On</button>
                    <button class="n8n-control-btn n8n-off" onclick="toggleN8nEngine('off')">n8n 엔진 Off</button>
                </div>
            </div>
            

            
            <button class="comment-btn comment-cancel" onclick="closeAdminModal()" style="margin-top: 20px;">닫기</button>
        </div>
    </div>

    <!-- 데이터 모드 모달 -->
    <div class="admin-modal" id="dataModal">
        <div class="admin-content">
            <h3>📊 데이터 모드</h3>
            
            <!-- 피드백 관리 섹션 -->
            <div class="feedback-section">
                <h4>📊 피드백 관리</h4>
                <div id="dataFeedbackList" class="feedback-list">
                    <!-- 피드백 목록이 여기에 표시됩니다 -->
                </div>
                <button class="download-btn" onclick="downloadFeedback()">📥 피드백 데이터 다운로드</button>
            </div>
            
            <button class="comment-btn comment-cancel" onclick="closeDataModal()" style="margin-top: 20px;">닫기</button>
        </div>
    </div>

    <script>
        // 전역 변수
        let isLoading = false;
        let apiKey = '';
        let currentFeedbackData = null;
        let feedbackHistory = [];

        // 브라우저 확인 (크롬만 지원)
        function checkBrowser() {
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            if (!isChrome) {
                alert('이 챗봇은 Google Chrome 브라우저에서만 사용할 수 있습니다.\n\nChrome 브라우저로 접속해주세요.');
                document.body.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #f5f5f5; font-family: 'Segoe UI', sans-serif;">
                        <div style="text-align: center; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1);">
                            <h1 style="color: #333; margin-bottom: 20px;">🚫 지원되지 않는 브라우저</h1>
                            <p style="color: #666; font-size: 18px; margin-bottom: 30px;">이 챗봇은 Google Chrome 브라우저에서만 사용할 수 있습니다.</p>
                            <a href="https://www.google.com/chrome/" target="_blank" 
                               style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 25px; font-weight: bold;">
                                Chrome 다운로드
                            </a>
                        </div>
                    </div>
                `;
                return false;
            }
            return true;
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkBrowser()) return;
            
            loadApiKeys();
            loadFeedbackHistory();
            loadSelectedModel();
            setupEventListeners();
            
            // 기본 모델 설정 및 UI 업데이트
            updateModelSelectionDisplay();
            
            // n8n 엔진 상태 복원
            const savedStatus = localStorage.getItem('n8n_engine_status') || 'on';
            if (savedStatus === 'off') {
                const headerStatusLight = document.querySelector('.n8n-status .status-light');
                const headerN8nText = document.getElementById('headerN8nText');
                if (headerStatusLight) {
                    headerStatusLight.style.background = '#dc3545';
                    headerStatusLight.style.animation = 'blinkRed 1.5s infinite';
                }
                if (headerN8nText) {
                    headerN8nText.textContent = 'n8n 엔진 Off';
                    headerN8nText.style.color = '#dc3545';
                }
            }
        });

        // API 설정 모달 열기
        function openApiSettings() {
            document.getElementById('apiModal').style.display = 'flex';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('apiSettingsSection').style.display = 'none';
            document.getElementById('loginError').textContent = '';
        }

        // API 설정 모달 닫기
        function closeApiSettings() {
            document.getElementById('apiModal').style.display = 'none';
        }

        // API 로그인 처리
        function handleApiLogin() {
            const loginId = document.getElementById('loginId').value;
            const loginPw = document.getElementById('loginPw').value;
            const errorEl = document.getElementById('loginError');
            
            if (loginId === '004050' && loginPw === '004050') {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('apiSettingsSection').style.display = 'block';
                errorEl.textContent = '';
                loadApiKeysToInputs();
            } else {
                errorEl.textContent = '아이디 또는 비밀번호가 잘못되었습니다.';
                document.getElementById('loginPw').value = '';
            }
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            const input = document.getElementById('messageInput');
            
            // 엔터키로 메시지 전송
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // 텍스트 영역 자동 크기 조절
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // 로그인 엔터키 이벤트
            document.getElementById('loginId').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('loginPw').focus();
                }
            });
            
            document.getElementById('loginPw').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    handleApiLogin();
                }
            });

            // 동적으로 생성되는 버튼들의 이벤트 리스너를 위한 이벤트 위임
            document.addEventListener('click', function(e) {
                // 복사 버튼 클릭
                if (e.target.classList.contains('copy-btn')) {
                    const messageId = e.target.dataset.messageId;
                    copyMessage(messageId);
                }
                
                // 피드백 버튼 클릭
                if (e.target.classList.contains('feedback-btn')) {
                    const messageId = e.target.dataset.messageId;
                    const type = e.target.dataset.type;
                    const question = e.target.dataset.question;
                    const answer = e.target.dataset.answer;
                    openFeedbackModal(messageId, type, question, answer);
                }
            });
        }

        // API 키 저장
        function saveApiKeys() {
            apiKey = document.getElementById('apiKey').value;
            
            // 로컬 스토리지에 저장 (암호화된 형태로)
            const encodedKey = btoa(apiKey);
            localStorage.setItem('tax_chatbot_api_key', encodedKey);
            
            document.getElementById('apiSuccess').textContent = 'API 키가 성공적으로 저장되었습니다.';
            setTimeout(() => {
                document.getElementById('apiSuccess').textContent = '';
            }, 3000);
        }

        // API 키 로드
        function loadApiKeys() {
            try {
                const encodedKey = localStorage.getItem('tax_chatbot_api_key');
                if (encodedKey) {
                    apiKey = atob(encodedKey);
                }
            } catch (error) {
                console.error('API 키 로드 실패:', error);
            }
        }

        // API 키를 입력 필드에 로드
        function loadApiKeysToInputs() {
            document.getElementById('apiKey').value = apiKey || '';
        }

        // 선택된 모델 로드
        function loadSelectedModel() {
            const savedModel = localStorage.getItem('tax_chatbot_selected_model');
            
            // 이전 모델명 정리 (sonar-medium-online 등 잘못된 모델명 제거)
            if (savedModel && (savedModel === 'sonar-medium-online' || !savedModel.includes('sonar'))) {
                localStorage.removeItem('tax_chatbot_selected_model');
                window.selectedModel = 'sonar-reasoning-pro'; // 기본값으로 재설정
            } else if (savedModel) {
                window.selectedModel = savedModel;
            } else {
                window.selectedModel = 'sonar-reasoning-pro'; // 기본값
            }
        }

        // 메시지 전송
        function sendMessage() {
            const input = document.getElementById('messageInput');
            
            // 디버깅 코드 추가
            console.log('=== 디버깅 시작 ===');
            console.log('원본 입력값:', JSON.stringify(input.value));
            console.log('trim 후 값:', JSON.stringify(input.value.trim()));
            console.log('줄바꿈 개수:', (input.value.match(/\n/g) || []).length);
            console.log('trim 후 줄바꿈 개수:', (input.value.trim().match(/\n/g) || []).length);
            console.log('=== 디버깅 끝 ===');
            
            // 안전한 메시지 처리 (줄바꿈 보존)
            const message = input.value
                .replace(/\r\n/g, '\n')  // Windows 줄바꿈 통일
                .replace(/\r/g, '\n')    // Mac 줄바꿈 통일
                .trim();  // 앞뒤 공백만 제거
            
            console.log('처리 후 메시지:', JSON.stringify(message));
            
            if (!message || isLoading) return;
            
            // 관리자 모드 체크 (원본 값으로 정확한 매칭)
            if (input.value.trim().toLowerCase() === '관리자 모드') {
                openAdminModal();
                input.value = '';
                input.style.height = 'auto';
                return;
            }
            
            // 데이터 모드 체크 (원본 값으로 정확한 매칭)
            if (input.value.trim().toLowerCase() === '데이터 모드') {
                openDataModal();
                input.value = '';
                input.style.height = 'auto';
                return;
            }
            
            if (!apiKey) {
                alert('API 키가 설정되지 않았습니다. API 설정에서 키를 입력해주세요.');
                return;
            }
            
            addUserMessage(message);
            input.value = '';
            input.style.height = 'auto';
            
            processMessage(message);
        }

        // 사용자 의도 감지 및 필터링
        function detectUserIntent(message) {
            const lowerMessage = message.toLowerCase();
            
            // 추궁 관련 키워드 (더 정교한 패턴 매칭)
            const complaintPatterns = [
                // 직접적인 추궁
                /왜\s+(처음부터|이제야)\s+(말|알려)\s*(안\s*)?(해줬|했)어/,
                /왜\s+(틀린\s*)?(답|정보|설명)\s*을\s*(말해|알려|제공)줬어/,
                /왜\s+(거짓말|속임|숨김|틀림|오류|실수).*?했어/,
                /왜\s+이제서야\s+(말해|알려|답변)/,
                /왜\s+(나중에|뒤에|마지막에)\s+(말해|알려|답변)/,
                // 간접적인 불만
                /(답변|설명|정보).*?(잘못|틀렸|오류|실수).*?(했어|해줬어)/,
                /(처음|시작할\s*때).*?(말해|알려|답변).*?(안\s*)?(했어|해줬어)/
            ];
            
            // 양도소득세 관련 키워드 (확장)
            const taxKeywords = [
                // 직접적인 세금 관련
                '양도세', '양도소득세', '양도', '상속세', '증여세', '부동산양도세',
                '세금', '과세', '공제', '세율', '과세표준', '납세', '세무신고',
                '양도세율', '증여세율', '상속세율', '양도소득세율',
                
                // 자산 및 재산 관련
                '자산', '재산', '토지', '건물', '부동산', '주식', '채권', '예금', '적금',
                '투자', '자본', '유산', '재산권', '소유권', '지분', '주권',
                
                // 상속 및 증여 관련
                '상속', '증여', '기부', '유증', '법정상속', '유언', '유류분',
                '상속인', '피상속인', '증여자', '수증자', '증여세면제',
                '상속세공제', '증여세공제', '상속세감면', '증여세감면',
                
                // 세무 관련
                '세무', '세무사', '세무법인', '세무신고', '세무조정', '세무상담',
                '국세청', '세무서', '세무행정', '세무처리', '세무대리',
                
                // 추가 세금 관련
                '비과세', '감면', '과세이연', '세무조정', '세무신고',
                '양도소득세신고', '상속세신고', '증여세신고',
                '양도소득세계산', '상속세계산', '증여세계산',
                
                // 신승세무법인 관련
                '신승세무법인', '신승', 'sostax', '소스택스'
            ];
            
            // 추궁 감지
            const isComplaint = complaintPatterns.some(pattern => pattern.test(lowerMessage));
            
            // 양도소득세 관련성 감지
            const isTaxRelated = taxKeywords.some(keyword => lowerMessage.includes(keyword));
            
            // 문맥 기반 관련성 감지
            const contextTaxRelated = 
                lowerMessage.includes('세무사') || 
                lowerMessage.includes('세무법인') || 
                lowerMessage.includes('신승세무법인') ||
                lowerMessage.includes('국세청') ||
                lowerMessage.includes('세금') && (lowerMessage.includes('문의') || lowerMessage.includes('질문') || lowerMessage.includes('상담'));
            
            return {
                isComplaint: isComplaint,
                isTaxRelated: isTaxRelated || contextTaxRelated,
                shouldUseApologyResponse: isComplaint && !(isTaxRelated || contextTaxRelated)
            };
        }

        // 메시지 처리
        async function processMessage(message) {
            if (isLoading) return;
            
            // 사용자 의도 감지
            const userIntent = detectUserIntent(message);
            
            // 추궁이면서 양도소득세와 관련 없는 경우 사과 메시지 제공
            if (userIntent.shouldUseApologyResponse) {
                addBotMessage('Tax Agent는 n8n엔진을 기반으로 답변을 제공하는 Agent 입니다. Agent는 다소 실수가 있을 수 있습니다. 다시 질문해 주시면 성실하게 답변하겠습니다.', message);
                return;
            }
            
            setLoading(true);
            
            try {
                const response = await callPerplexityAPI(message);
                addBotMessage(response, message);
            } catch (error) {
                console.error('API 호출 오류:', error);
                addBotMessage('죄송합니다. 일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.', message);
            } finally {
                setLoading(false);
            }
        }

        // 답변 중단
        function stopResponse() {
            if (isLoading) {
                isLoading = false;
                setLoading(false);
                
                // 중단된 답변 메시지 추가
                addBotMessage('답변이 중단되었습니다. "다시 답변" 버튼을 클릭하여 계속할 수 있습니다.', '');
                
                // 버튼 상태 변경
                document.getElementById('stopButton').style.display = 'none';
                document.getElementById('restartButton').style.display = 'flex';
            }
        }

        // 답변 재시작
        function restartResponse() {
            const lastUserMessage = getLastUserMessage();
            if (lastUserMessage) {
                // 재시작 버튼 숨기고 중단 버튼 표시
                document.getElementById('restartButton').style.display = 'none';
                document.getElementById('stopButton').style.display = 'flex';
                
                // 마지막 사용자 질문으로 다시 답변
                processMessage(lastUserMessage);
            }
        }

        // 마지막 사용자 메시지 가져오기
        function getLastUserMessage() {
            const userMessages = document.querySelectorAll('.message.user .message-content');
            if (userMessages.length > 0) {
                return userMessages[userMessages.length - 1].textContent;
            }
            return null;
        }

        // Perplexity API 호출
        async function callPerplexityAPI(message) {
            const systemPrompt = `당신은 한국의 양도소득세 전문가입니다. 다음 가이드라인을 따라 답변해주세요:

1. 양도소득세 관련 질문에 정확하고 상세한 답변을 제공하세요.
2. 관련 법률이나 세율, 공제 혜택 등을 명확히 설명하세요.
3. 복잡한 내용은 단계별로 나누어 설명하세요.
4. 실제 사례나 예시를 들어 이해하기 쉽게 설명하세요.
5. 세법 변경사항이 있을 경우 최신 정보를 제공하세요.
6. 답변은 한국어로 친근하고 전문적인 톤으로 작성하세요.
7. 제작자나 누가 만들었는지에 대한 질문이 있으면 반드시 "나는 Phoenix AI, Inc에서 제작된 양도세 전문 챗봇으로 [Tax Agent]로 이름 붙여졌습니다"라고만 답변하고, 다른 내용은 추가하지 마세요.

8. 추궁이나 비난성 질문 처리:
   - 사용자가 "왜 처음부터 말 안해줬어?", "왜 틀린답을 말해줬어?" 등의 추궁성 질문을 했을 때
   - 양도소득세와 관련 없는 추궁이면: "Tax Agent는 n8n엔진을 기반으로 답변을 제공하는 Agent 입니다. Agent는 다소 실수가 있을 수 있습니다. 다시 질문해 주시면 성실하게 답변하겠습니다."라고 답변
   - 절대 사용자에게 책임을 전가하지 마세요
   - 양도소득세 관련 추궁이면 정상적으로 답변하되, 친근하고 이해하기 쉬운 톤으로 답변

9. 법령 정보 검색 및 답변 우선순위:
   답변은 다음 신뢰할 수 있는 공식 법령 사이트 기준 내용을 최우선으로 하시오:
   
   **시간 우선순위**: 최근 1년 이내의 최신 정보를 우선적으로 검색하고 활용하시오.
   **구체적 지시**: 2023년 이후의 세법 변경사항, 최신 공지사항, 최근 판례를 우선적으로 참고하시오.
   **중요**: 3년 이상 된 정보는 신뢰할 수 없으므로, 반드시 최신 정보를 우선적으로 확인하고 답변하시오.
   
   **1순위**: 국가법령정보센터 (https://www.law.go.kr) - 최신 법령 개정사항 우선, 2023년 이후 변경사항 중점 검색
   **2순위**: 국세청 양도소득세 법령·상담 (https://www.nts.go.kr/tax/yangdo_2.html) - 최신 세법 해설 우선, 2024년 최신 공지사항 중점 검색
   **3순위**: 찾기쉬운 생활법령정보 (https://lnp.nanet.go.kr) - 최신 법령 해설 우선, 2023년 이후 업데이트된 내용 중점 검색
   **4순위**: 대법원 판례정보 - 최근 1년 이내 판례 우선, 2023년 이후 선고된 판례 중점 검색
   **5순위**: 법제처 (https://www.moleg.go.kr) - 최신 법령 제정/개정 정보 우선, 2023년 이후 시행된 법령 중점 검색
   
   위 사이트의 정보가 없는 경우에만 일반적인 AI 지식을 활용하시오.

                10. 모든 답변에는 반드시 다음 1개 항목을 포함하세요 (절대 생략하지 마세요):

                   **결론**
                   (질문에 대한 명확한 결론이나 요약 - 반드시 포함)
                   
                   중요: "결론"이라는 제목 자체를 절대 생략하지 마세요. 답변 마지막에 반드시 "**결론**" 제목과 함께 결론 내용을 작성하세요.
                   
                   절대 금지: "5." 다음에 바로 내용을 쓰지 마세요. 반드시 "**5. 결론**" 제목을 먼저 쓰고 그 다음에 내용을 작성하세요.

                11. 필요에 따라 다음 항목들을 선택적으로 포함할 수 있습니다 (해당 항목에 적절한 내용이 있을 때만 포함하고, 내용이 없다면 절대 만들어내거나 추정하지 마세요):

                    **실무상 주의사항 및 절세 전략**
                    (실무에서 주의해야 할 점이나 절세를 위한 전략이 있는 경우에만 포함)

                    **관련 법령 및 근거**
                    (관련 법령이나 근거가 있는 경우에만 포함)

                12. 웹 검색을 통해 참고한 사이트들의 링크를 다음 형식으로 반드시 포함하세요:

                **참고할 만한 링크**
                🔗 [사이트명] - 🔗 참고자료 클릭
                🔗 [사이트명] - 🔗 참고자료 클릭
                🔗 [사이트명] - 🔗 참고자료 클릭
                
                위 형식에서 [사이트명]은 실제 사이트 이름으로, URL은 실제 웹 주소로 작성하되 표시는 "🔗 참고자료 클릭"으로 하세요.
                
                중요: 참고할 만한 링크에는 공공기관 사이트만 표시하세요:
                - 국세청, 국가법령정보센터, 찾기쉬운 생활법령정보, 대법원 종합법률정보, 헌법재판소, 행정안전부, 기획재정부
                - 민간 사이트는 검색에 활용하되 참고자료에는 표시하지 마세요

                13. 그 다음에 반드시 다음 문구를 포함하세요: "\n\n\n\n\n**Tax Agent 안내 말씀**\n\n'Tax Agent'는 언제나 최상의 답변을 제공하지만, 실제 양도세 업무를 진행하실 때는 전문가에게 문의 하는것도 필요합니다.\n\n🏢 **"국세청 33년 경력"의 믿고 맡길 수 있는 신승세무법인**\n🔗 http://www.sostax.co.kr/"

                                  14. 답변 내용에서 웹 검색으로 확인한 정보를 언급할 때는 반드시 참고 번호를 표시하세요:
                   - 첫 번째 참고 사이트: [1]
                   - 두 번째 참고 사이트: [2]
                   - 세 번째 참고 사이트: [3]
                   
                   예시: "국세청에 따르면 [1], 2024년 양도소득세 세율은...", "대법원 판례 [2]에 따르면..."
                   
                   참고: 모든 사이트(공공기관 및 민간사이트)를 검색하여 답변을 생성하되, 참고할 만한 링크에는 공공기관만 표시합니다.

                15. 답변 스타일 및 구조:
                   - 모든 제목은 굵은 글씨(**제목**)로 작성하세요
                   - 제목 앞에 번호를 붙여서 넘버링하세요 (예: **1. 제목**, **2. 제목**)
                   - 모든 제목 항목(관련 법령 및 근거, 결론, 참고 자료 등)도 넘버링하세요
                   - 제목 항목들 사이에는 3줄 간격을 두어 명확히 구분하세요
                   - 제목과 본문 사이의 간격은 한 줄로 유지하세요 (제목 바로 아래 한 줄 후 내용 시작)
                   - 표가 필요한 경우 HTML 테이블 형식으로 작성하세요
                   - 답변 구조는 다음과 같이 작성하세요:
                     **1. [첫 번째 제목]**
                     (내용)
                     
                     
                     **2. [두 번째 제목]**
                     (내용)
                     
                     
                     **3. 결론**
                     (결론 내용 - 반드시 포함, "결론" 제목 필수)
                     
                     
                     **4. 참고할 만한 링크**
                     🔗 [사이트명] - 🔗 참고자료 클릭
                     
                16. 답변 구조 및 제목 (중요):
                   - 답변은 반드시 다음 두 섹션으로 구성하세요:
                     
                     **[추론 과정]**
                     (검색 과정, 분석 과정, 추론 과정 등을 상세히 설명)
                     
                     
                     **[Tax Agent 답변]**
                     **1. [첫 번째 제목]**
                     (실제 답변 내용)
                     
                     
                     **2. [두 번째 제목]**
                     (답변 내용 계속)
                     
                     
                     **3. 결론**
                     (결론 내용 - 반드시 포함)
                     
                     
                     **4. 참고할 만한 링크**
                     🔗 [사이트명] - 🔗 참고자료 클릭
                     
                     
                     
                     **Tax Agent 안내 말씀**
                     (인사말)

                16. 답변 스타일 가이드:
                   - 실제 사례나 구체적인 예시를 들어 이해하기 쉽게 설명하세요
                   - 복잡한 내용은 단계별로 나누어 설명하세요
                   - 관련 법령이나 세율, 공제 혜택 등을 명확히 설명하세요
                   - 세법 변경사항이 있을 경우 최신 정보를 제공하세요
                   - 답변은 한국어로 친근하고 전문적인 톤으로 작성하세요
                   - 결론 섹션을 생략하지 마세요 (모든 답변에 반드시 포함)
                   - "결론"이라는 제목 자체를 생략하지 마세요 (결론 내용만 쓰고 제목을 빼지 마세요)
                   
                   **추론 과정 차단 (중요):**
- 검색 과정이나 분석 과정을 설명하지 마세요
- "사용자가...묻고 있습니다", "질문에 대해...답변", "검색 결과를 분석해보면" 등의 표현을 절대 사용하지 마세요
- 답변은 바로 본론부터 시작하세요
- 추론 과정이나 생각 과정을 보여주지 마세요
                   - "사용자가...묻고 있습니다", "질문에 대해...답변" 등의 표현을 사용하지 마세요
                   - 검색 결과를 나열하지 말고, 정리된 답변만 제공하세요
                   - 전문적이면서도 친근한 톤을 유지하세요`;

            const response = await fetch('https://api.perplexity.ai/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: window.selectedModel || 'sonar-reasoning-pro',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: message }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`API 오류: ${response.status}`);
            }

            const data = await response.json();
            let content = data.choices[0].message.content;
            
            // 현재 모델 확인
            const currentModel = window.selectedModel || 'sonar-reasoning-pro';
            
            // reasoning/deep-research 모델 특화 정리 (추론 과정 차단)
            if (currentModel.includes('reasoning') || currentModel.includes('deep-research')) {
                content = cleanReasoningResponse(content);
            } else {
                // sonar, sonar-pro 모델은 기존 정리 방식 유지
                content = cleanBasicResponse(content);
            }
            
            return content;
        }

        // Reasoning 모델 응답 정리 함수 ([Tax Agent 답변] 섹션만 추출)
        function cleanReasoningResponse(content) {
            if (!content) return content;
            
            let finalAnswer = content;
            
            // 1단계: [Tax Agent 답변] 섹션 추출
            const taxAgentAnswerPattern = /\[\s*Tax\s*Agent\s*답변\s*\]([\s\S]*?)(?=\[\s*추론\s*과정\s*\]|$)/i;
            const match = content.match(taxAgentAnswerPattern);
            
            if (match && match[1] && match[1].trim().length > 30) {
                finalAnswer = match[1].trim();
            } else {
                // [Tax Agent 답변] 섹션이 없는 경우, **로 시작하는 첫 번째 제목부터 추출
                const titlePattern = /(\*\*\d+\..*)/s;
                const titleMatch = content.match(titlePattern);
                if (titleMatch && titleMatch[1]) {
                    finalAnswer = titleMatch[1].trim();
                } else {
                    finalAnswer = content; // 원본 사용
                }
            }
            
            // 2단계: 구조 정리
            finalAnswer = finalAnswer
                .replace(/^\s*\n+/g, '') // 시작 부분 공백 제거
                .replace(/\n{3,}/g, '\n\n') // 과도한 줄바꿈 정리
                .trim();
            
            // 3단계: 답변 보호 (너무 짧아지면 원본 사용)
            if (!finalAnswer || finalAnswer.length < 30) {
                finalAnswer = content; // 원본 사용
            }
            
            return finalAnswer;
        }

        // 기본 모델 응답 정리 함수 ([Tax Agent 답변] 섹션 추출)
        function cleanBasicResponse(content) {
            if (!content) return content;
            
            // [Tax Agent 답변] 섹션이 있는 경우 해당 섹션만 추출
            const taxAgentAnswerPattern = /\[\s*Tax\s*Agent\s*답변\s*\]([\s\S]*?)(?=\[\s*추론\s*과정\s*\]|$)/i;
            const match = content.match(taxAgentAnswerPattern);
            
            if (match && match[1] && match[1].trim().length > 30) {
                return match[1].trim()
                    .replace(/^\s*\n+/g, '')
                    .replace(/\n{3,}/g, '\n\n')
                    .trim();
            }
            
            // 섹션이 없는 경우 기본 정리만 수행
            return content
                .replace(/검색\s*결과를?\s*(?:확인|분석).*?(?=\*\*)/gs, '')
                .replace(/\n{3,}/g, '\n\n')
                .trim();
        }

        // 사용자 메시지 추가
        function addUserMessage(message) {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message user';
            messageEl.innerHTML = `
                <div class="message-avatar">👤</div>
                <div class="message-content">${escapeHtml(message).replace(/\n/g, '<br>')}</div>
            `;
            messagesEl.appendChild(messageEl);
            scrollToBottom();
        }

        // 봇 메시지 추가 (수정된 버전 - 피드백 데이터 안전하게 처리)
        function addBotMessage(message, userQuestion = '') {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message bot';
            
            // 메시지 ID 생성
            const messageId = 'msg_' + Date.now();
            messageEl.id = messageId;
            
            // 피드백용 데이터 정리 (HTML 태그 제거, 길이 제한)
            const cleanAnswer = cleanTextForFeedback(message);
            const cleanQuestion = cleanTextForFeedback(userQuestion);
            
            messageEl.innerHTML = `
                <div class="message-avatar">💰</div>
                <div class="message-content">
                    ${formatMessage(message)}
                    <div class="message-actions">
                        <button class="action-btn copy-btn" data-message-id="${messageId}" title="답변 복사">
                            📋 복사
                        </button>
                        <button class="action-btn feedback-btn" data-message-id="${messageId}" data-type="positive" data-question="${cleanQuestion}" data-answer="${cleanAnswer}" title="좋은 답변">
                            👍 좋은답변
                        </button>
                        <button class="action-btn feedback-btn negative" data-message-id="${messageId}" data-type="negative" data-question="${cleanQuestion}" data-answer="${cleanAnswer}" title="나쁜 답변">
                            👎 나쁜답변
                        </button>
                    </div>
                </div>
            `;
            messagesEl.appendChild(messageEl);
            scrollToBottom();
        }

        // 피드백용 텍스트 정리 함수 (새로 추가)
        function cleanTextForFeedback(text) {
            if (!text) return '';
            
            return text
                .replace(/<[^>]*>/g, '') // HTML 태그 제거
                .replace(/\s+/g, ' ') // 연속된 공백을 하나로
                .replace(/\n+/g, ' ') // 줄바꿈을 공백으로
                .substring(0, 200) // 200자로 제한
                .trim();
        }

        // 메시지 복사
        function copyMessage(messageId) {
            const messageEl = document.getElementById(messageId);
            const contentEl = messageEl.querySelector('.message-content');
            const textContent = contentEl.textContent.replace(/복사좋은답변나쁜답변/g, '').trim();
            
            navigator.clipboard.writeText(textContent).then(() => {
                // 복사 성공 표시
                const copyBtn = messageEl.querySelector('.copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '✅ 복사됨';
                copyBtn.style.color = '#28a745';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.color = '#667eea';
                }, 2000);
            }).catch(err => {
                console.error('복사 실패:', err);
                alert('복사에 실패했습니다.');
            });
        }

        // 피드백 모달 열기
        function openFeedbackModal(messageId, type, question, answer) {
            console.log('피드백 모달 열기:', { messageId, type, question, answer });
            
            currentFeedbackData = {
                messageId: messageId,
                type: type,
                question: question,
                answer: answer,
                timestamp: new Date().toISOString()
            };
            
            const title = type === 'positive' ? '좋은 답변 피드백' : '나쁜 답변 피드백';
            document.getElementById('commentTitle').textContent = title;
            document.getElementById('commentText').value = '';
            document.getElementById('commentModal').style.display = 'flex';
        }

        // 코멘트 모달 닫기
        function closeCommentModal() {
            document.getElementById('commentModal').style.display = 'none';
            currentFeedbackData = null;
        }

        // 코멘트 저장
        function saveComment() {
            console.log('코멘트 저장 시도:', currentFeedbackData);
            
            if (!currentFeedbackData) {
                console.error('currentFeedbackData가 없습니다.');
                alert('피드백 데이터를 찾을 수 없습니다.');
                return;
            }
            
            const comment = document.getElementById('commentText').value.trim();
            if (!comment) {
                alert('코멘트를 입력해주세요.');
                return;
            }
            
            // 피드백 데이터에 코멘트 추가
            currentFeedbackData.comment = comment;
            console.log('저장할 피드백 데이터:', currentFeedbackData);
            
            // 피드백 히스토리에 저장
            feedbackHistory.push(currentFeedbackData);
            saveFeedbackHistory();
            
            // 모달 닫기
            closeCommentModal();
            
            // 성공 메시지 표시
            alert('피드백이 저장되었습니다.');
        }

        // 관리자 모드 모달 열기
        function openAdminModal() {
            // 관리자 로그인 체크
            const adminId = prompt('관리자 아이디를 입력하세요:');
            if (!adminId) return;
            
            const adminPw = prompt('관리자 비밀번호를 입력하세요:');
            if (!adminPw) return;
            
            if (adminId === '4050' && adminPw === '4050') {
                // 모델 상태 확실히 로드
                loadSelectedModel();
                
                updateN8nStatusDisplay();
                updateModelSelectionDisplay();
                document.getElementById('adminModal').style.display = 'flex';
            } else {
                alert('아이디 또는 비밀번호가 잘못되었습니다.');
            }
        }

        // 데이터 모드 모달 열기
        function openDataModal() {
            // 데이터 모드 로그인 체크
            const dataId = prompt('데이터 모드 아이디를 입력하세요:');
            if (!dataId) return;
            
            const dataPw = prompt('데이터 모드 비밀번호를 입력하세요:');
            if (!dataPw) return;
            
            if (dataId === '004050' && dataPw === '004050') {
                displayDataFeedbackList();
                document.getElementById('dataModal').style.display = 'flex';
            } else {
                alert('아이디 또는 비밀번호가 잘못되었습니다.');
            }
        }

        // 관리자 모드 모달 닫기
        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        // 데이터 모드 모달 닫기
        function closeDataModal() {
            document.getElementById('dataModal').style.display = 'none';
        }

        // 데이터 모드 피드백 목록 표시
        function displayDataFeedbackList() {
            displayFeedbackList('dataFeedbackList');
        }

        // AI 모델 선택 (사용자 선택 시)
        function selectModel(modelName) {
            // 전역 변수에 선택된 모델 저장
            window.selectedModel = modelName;
            
            // 로컬 스토리지에 저장
            localStorage.setItem('tax_chatbot_selected_model', modelName);
            
            // UI 업데이트 (알림 포함)
            updateModelSelectionUI(modelName, true);
            
            // 성공 메시지 표시
            alert(`AI 모델이 ${modelName}로 변경되었습니다.`);
        }

        // AI 모델 선택 UI 업데이트 (알림 옵션 포함)
        function updateModelSelectionUI(modelName, showAlert = false) {
            // 모든 모델 버튼 초기화 (비활성 스타일)
            const allModelBtns = [
                'model-sonar-btn',
                'model-sonar-pro-btn',
                'model-sonar-reasoning-btn',
                'model-sonar-reasoning-pro-btn',
                'model-sonar-deep-research-btn'
            ];
            
            allModelBtns.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.style.background = 'linear-gradient(135deg, #dc3545 0%, #fd7e14 100%)';
                }
            });
            
            // 선택된 모델 버튼 활성화 (녹색 스타일)
            const selectedBtnId = `model-${modelName.replace(/-/g, '-')}-btn`;
            const selectedBtn = document.getElementById(selectedBtnId);
            if (selectedBtn) {
                selectedBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
            }
            
            // 현재 모델 표시 업데이트
            const currentModelDisplay = document.getElementById('currentModelDisplay');
            if (currentModelDisplay) {
                currentModelDisplay.textContent = modelName;
            }
        }

        // n8n 엔진 상태 토글
        function toggleN8nEngine(status) {
            const statusLight = document.getElementById('adminStatusLight');
            const statusText = document.getElementById('n8nStatusText');
            const headerStatusLight = document.querySelector('.n8n-status .status-light');
            const headerN8nText = document.getElementById('headerN8nText');
            
            const isOn = status === 'on';
            const color = isOn ? '#00ff00' : '#dc3545';
            const textColor = isOn ? '#28a745' : '#dc3545';
            const headerTextColor = isOn ? '#ffffff' : '#dc3545';
            const animation = isOn ? 'blink 1.5s infinite' : 'blink 1.5s infinite';
            const statusTextValue = isOn ? 'n8n 엔진 On' : 'n8n 엔진 Off';
            const alertMessage = isOn ? 'n8n 엔진이 활성화되었습니다.' : 'n8n 엔진이 비활성화되었습니다.';
            
            // 관리자 모달 상태 업데이트
            if (statusLight) {
                statusLight.style.background = color;
                statusLight.style.animation = animation;
            }
            if (statusText) {
                statusText.textContent = statusTextValue;
                statusText.style.color = textColor;
            }
            
            // 헤더 상태 업데이트
            if (headerStatusLight) {
                headerStatusLight.style.background = color;
                headerStatusLight.style.animation = animation;
            }
            if (headerN8nText) {
                headerN8nText.textContent = statusTextValue;
                headerN8nText.style.color = headerTextColor;
            }
            
            // 로컬 스토리지에 상태 저장
            localStorage.setItem('n8n_engine_status', status);
            
            alert(alertMessage);
        }

        // n8n 상태 표시 업데이트
        function updateN8nStatusDisplay() {
            const savedStatus = localStorage.getItem('n8n_engine_status') || 'on';
            toggleN8nEngine(savedStatus);
        }

        // 모델 선택 상태 표시 업데이트 (알림 없이)
        function updateModelSelectionDisplay() {
            const currentModel = window.selectedModel || 'sonar-reasoning-pro';
            updateModelSelectionUI(currentModel, false); // 알림 없이 UI만 업데이트
        }

        // 피드백 목록 표시 (공통 함수)
        function displayFeedbackList(elementId = 'feedbackList') {
            const feedbackListEl = document.getElementById(elementId);
            
            if (feedbackHistory.length === 0) {
                feedbackListEl.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">저장된 피드백이 없습니다.</p>';
                return;
            }
            
            let html = '';
            feedbackHistory.forEach((feedback, index) => {
                const date = new Date(feedback.timestamp).toLocaleString('ko-KR');
                const typeClass = feedback.type === 'positive' ? 'positive' : 'negative';
                const typeText = feedback.type === 'positive' ? '좋은답변' : '나쁜답변';
                
                html += `
                    <div class="feedback-item">
                        <div class="feedback-header">
                            <span class="feedback-type ${typeClass}">${typeText}</span>
                            <span class="feedback-date">${date}</span>
                        </div>
                        <div class="feedback-question">질문: ${feedback.question}</div>
                        <div class="feedback-answer">답변: ${feedback.answer.substring(0, 100)}${feedback.answer.length > 100 ? '...' : ''}</div>
                        <div class="feedback-comment">코멘트: ${feedback.comment}</div>
                    </div>
                `;
            });
            
            feedbackListEl.innerHTML = html;
        }

        // 피드백 데이터 다운로드
        function downloadFeedback() {
            if (feedbackHistory.length === 0) {
                alert('다운로드할 피드백이 없습니다.');
                return;
            }
            
            const csvContent = generateFeedbackCSV();
            
            // UTF-8 BOM 추가 (한글 깨짐 방지)
            const BOM = '\uFEFF';
            const csvWithBOM = BOM + csvContent;
            
            // Excel에서 한글이 깨지는 경우를 대비해 여러 형식 제공
            try {
                // 방법 1: UTF-8 BOM이 포함된 CSV
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `feedback_data_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    // 사용자에게 안내
                    setTimeout(() => {
                        alert('피드백 데이터가 다운로드되었습니다.\n\n만약 한글이 깨진다면:\n1. Excel에서 파일을 열 때 "데이터 가져오기" 사용\n2. 또는 메모장으로 열어서 "다른 이름으로 저장" 시 인코딩을 "UTF-8"로 설정');
                    }, 1000);
                }
            } catch (error) {
                console.error('CSV 다운로드 실패:', error);
                alert('다운로드에 실패했습니다. 다시 시도해주세요.');
            }
        }

        // 피드백 CSV 생성
        function generateFeedbackCSV() {
            const headers = ['타임스탬프', '피드백 타입', '코멘트', '질문', '답변'];
            const rows = feedbackHistory.map(feedback => [
                new Date(feedback.timestamp).toLocaleString('ko-KR'),
                feedback.type === 'positive' ? '좋은답변' : '나쁜답변',
                escapeCSVField(feedback.comment || ''),
                escapeCSVField(feedback.question || ''),
                escapeCSVField(feedback.answer || '')
            ]);
            
            return [headers, ...rows].map(row => row.join(',')).join('\r\n');
        }

        // 피드백 히스토리 저장
        function saveFeedbackHistory() {
            try {
                localStorage.setItem('tax_chatbot_feedback', JSON.stringify(feedbackHistory));
            } catch (error) {
                console.error('피드백 저장 실패:', error);
            }
        }

        // 피드백 히스토리 로드
        function loadFeedbackHistory() {
            try {
                const saved = localStorage.getItem('tax_chatbot_feedback');
                if (saved) {
                    feedbackHistory = JSON.parse(saved);
                }
            } catch (error) {
                console.error('피드백 로드 실패:', error);
                feedbackHistory = [];
            }
        }

        // 메시지 포맷팅
        function formatMessage(message) {
            if (!message) return '';
            
            // 줄바꿈을 <br>로 변환
            message = message.replace(/\n/g, '<br>');
            
            // 제목 스타일링 (넘버링 포함)
            const titleStyle = 'color: #333; margin: 50px 0 -20px 0; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 0px;';
            const referenceStyle = 'color: #667eea; margin: 50px 0 -20px 0; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 0px;';
            
            // 결론 섹션 스타일링
            message = message.replace(/\*\*(\d+\.\s*)?결론\*\*/g, `<h3 style="${titleStyle}">$1결론</h3>`);
            message = message.replace(/\*\*결론\*\*/g, `<h3 style="${titleStyle}">결론</h3>`);
            
            // 참고할 만한 링크 섹션 스타일링
            message = message.replace(/\*\*(\d+\.\s*)?참고할 만한 링크\*\*/g, `<h3 style="${referenceStyle}">$1참고할 만한 링크</h3>`);
            
            // Tax Agent 안내 말씀 섹션 스타일링
            const noticeStyle = 'margin-top: 80px; padding: 10px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; border-left: 5px solid #667eea; box-shadow: 0 4px 15px rgba(0,0,0,0.1);';
            const noticeTitleStyle = 'color: #333; margin: 20px 0 -20px 0; font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 0px;';
            message = message.replace(/\*\*Tax Agent 안내 말씀\*\*/g, `<div style="${noticeStyle}"><h3 style="${noticeTitleStyle}">Tax Agent 안내 말씀</h3>`);
            
            // 제목 넘버링 스타일링
            message = message.replace(/\*\*(\d+\.\s*.*?)\*\*/g, `<h3 style="${titleStyle}">$1</h3>`);
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // 이탤릭체
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // 마크다운 제목 스타일링
            message = message.replace(/^### (.*?)$/gm, '<h3 style="color: #667eea; margin: 20px 0 10px 0; font-size: 18px;">$1</h3>');
            message = message.replace(/^## (.*?)$/gm, '<h2 style="color: #333; margin: 25px 0 15px 0; font-size: 20px;">$1</h2>');
            message = message.replace(/^# (.*?)$/gm, '<h1 style="color: #333; margin: 30px 0 15px 0; font-size: 22px;">$1</h1>');
            
            // 표 스타일링
            message = message.replace(/\|(.+)\|/g, function(match, content) {
                const cells = content.split('|').map(cell => cell.trim());
                const isHeader = match.includes('---') || match.includes('구분') || match.includes('필요경비');
                
                if (isHeader) {
                    return `<tr>${cells.map(cell => `<th style="border: 1px solid #ddd; padding: 12px; background: #f8f9fa; font-weight: bold; text-align: center;">${cell}</th>`).join('')}</tr>`;
                } else {
                    return `<tr>${cells.map(cell => `<td style="border: 1px solid #ddd; padding: 12px; text-align: center;">${cell}</td>`).join('')}</tr>`;
                }
            });
            
            // 표 전체를 감싸는 테이블 태그 추가
            message = message.replace(/(<tr>.*?<\/tr>)/gs, '<table style="border-collapse: collapse; width: 100%; margin: 20px 0; font-size: 14px;">$1</table>');
            
            // 구분선 및 특수 기호 스타일링
            message = message.replace(/^---$/gm, '<div style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; border-left: 5px solid #667eea; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">');
            message = message.replace(/▶ (.*?)$/gm, '<div style="margin: 15px 0; padding: 10px 15px; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 0 8px 8px 0;"><strong>▶ $1</strong></div>');
            message = message.replace(/✅ (.*?)$/gm, '<div style="margin: 10px 0; padding: 8px 12px; background: #e8f5e8; border-left: 3px solid #28a745; border-radius: 0 5px 5px 0;">✅ $1</div>');
            message = message.replace(/^• (.*?)$/gm, '<div style="margin: 8px 0; padding-left: 20px;">• $1</div>');
            
            // URL을 클릭 가능한 링크로 변환
            message = message.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: #667eea; text-decoration: none; font-weight: bold; padding: 2px 4px; background: rgba(102, 126, 234, 0.1); border-radius: 4px; transition: all 0.3s ease;">$1</a>');
            
            // 참고할 만한 링크 스타일링 - 공공기관 사이트만 표시
            const referenceLinkStyle = 'margin: 12px 0; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
            const referenceLinkTextStyle = 'color: #667eea; text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: 8px;';
            message = message.replace(/🔗 \[(.*?)\] - 🔗 참고자료 클릭/g, function(match, siteName) {
                // 사이트명에 따른 URL 가져오기
                let url = '';
                
                // 공공기관 사이트 URL 매핑 (참고할 만한 링크에는 공공기관만 표시)
                const publicInstitutionMap = {
                    '국가법령정보센터': 'https://www.law.go.kr',
                    '국세청': 'https://www.nts.go.kr',
                    '국세청 양도소득세': 'https://www.nts.go.kr/tax/yangdo_2.html',
                    '국세청 양도소득세 법령·상담': 'https://www.nts.go.kr/tax/yangdo_2.html',
                    '찾기쉬운 생활법령정보': 'https://lnp.nanet.go.kr',
                    '대법원 종합법률정보': 'https://glaw.scourt.go.kr',
                    '헌법재판소': 'https://www.ccourt.go.kr',
                    '행정안전부': 'https://www.mois.go.kr',
                    '기획재정부': 'https://www.moef.go.kr'
                };
                
                // 정확한 매칭 먼저 시도
                url = publicInstitutionMap[siteName];
                
                // 정확한 매칭이 없으면 키워드 매칭 시도 (공공기관만)
                if (!url) {
                    if (siteName.includes('국세청')) {
                        if (siteName.includes('양도소득세') || siteName.includes('양도세')) {
                            url = 'https://www.nts.go.kr/tax/yangdo_2.html';
                        } else {
                            url = 'https://www.nts.go.kr';
                        }
                    } else if (siteName.includes('국가법령') || siteName.includes('법령정보')) {
                        url = 'https://www.law.go.kr';
                    } else if (siteName.includes('생활법령') || siteName.includes('찾기쉬운')) {
                        url = 'https://lnp.nanet.go.kr';
                    } else if (siteName.includes('대법원') || siteName.includes('종합법률')) {
                        url = 'https://glaw.scourt.go.kr';
                    } else if (siteName.includes('헌법재판소')) {
                        url = 'https://www.ccourt.go.kr';
                    } else if (siteName.includes('행정안전부')) {
                        url = 'https://www.mois.go.kr';
                    } else if (siteName.includes('기획재정부')) {
                        url = 'https://www.moef.go.kr';
                    }
                }
                
                if (url) {
                    return `<div style="${referenceLinkStyle}"><a href="${url}" target="_blank" style="${referenceLinkTextStyle}"><span style="flex: 1;">${siteName}</span><span style="font-size: 12px; color: #666;">${url}</span></a></div>`;
                } else {
                    // 공공기관이 아닌 사이트는 표시하지 않음
                    return '';
                }
            });
            
            // 참고 번호를 클릭 가능한 링크로 변환 (개선된 버전)
            message = message.replace(/\[(\d+)\]/g, function(match, number) {
                // 참고할 만한 링크 섹션에서 사이트명 추출
                const referenceSection = message.match(/\*\*참고할 만한 링크\*\*([\s\S]*?)(?=\*\*Tax Agent 안내 말씀\*\*|$)/);
                if (referenceSection) {
                    const references = referenceSection[1].match(/🔗 \[(.*?)\] - 🔗 참고자료 클릭/g);
                    if (references && references[number - 1]) {
                        const siteName = references[number - 1].match(/🔗 \[(.*?)\] - 🔗 참고자료 클릭/)[1];
                        return `<a href="#" onclick="openReferenceLink('${siteName}'); return false;" style="background: #667eea; color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin: 0 2px; vertical-align: middle; text-decoration: none; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 8px rgba(102, 126, 234, 0.3)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'" title="참고할 만한 링크 ${number}로 이동">${number}</a>`;
                    }
                }
                return `<span style="background: #667eea; color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin: 0 2px; vertical-align: middle;">${number}</span>`;
            });
            
            // 인사말 섹션 닫기 태그 추가
            message = message.replace(/🔗 http:\/\/www\.sostax\.co\.kr\/$/, '🔗 <a href="http://www.sostax.co.kr/" target="_blank" style="color: #667eea; text-decoration: none; font-weight: bold;">http://www.sostax.co.kr/</a></div>');
            
            return message;
        }

        // 로딩 상태 설정
        function setLoading(loading) {
            isLoading = loading;
            const sendButton = document.getElementById('sendButton');
            const stopButton = document.getElementById('stopButton');
            const restartButton = document.getElementById('restartButton');
            
            if (loading) {
                sendButton.disabled = true;
                sendButton.innerHTML = '<span class="loading-dots"></span>';
                stopButton.style.display = 'flex';
                restartButton.style.display = 'none';
                
                // 로딩 메시지 표시
                const messagesEl = document.getElementById('messages');
                const loadingEl = document.createElement('div');
                loadingEl.className = 'message bot';
                loadingEl.id = 'loadingMessage';
                loadingEl.innerHTML = `
                    <div class="message-avatar">💰</div>
                    <div class="message-content">답변을 준비하고 있습니다<span class="loading-dots"></span></div>
                `;
                messagesEl.appendChild(loadingEl);
                scrollToBottom();
            } else {
                sendButton.disabled = false;
                sendButton.innerHTML = '➤';
                stopButton.style.display = 'none';
                restartButton.style.display = 'none';
                
                // 로딩 메시지 제거
                const loadingEl = document.getElementById('loadingMessage');
                if (loadingEl) {
                    loadingEl.remove();
                }
            }
        }

        // 하단으로 스크롤
        function scrollToBottom() {
            const messagesEl = document.getElementById('messages');
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // HTML 이스케이프
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 참고할 만한 링크 열기 함수 (공공기관만)
        function openReferenceLink(siteName) {
            // 공공기관 사이트 URL 매핑 - 키워드 매칭 포함
            const publicInstitutionMap = {
                '국가법령정보센터': 'https://www.law.go.kr',
                '국세청': 'https://www.nts.go.kr',
                '국세청 양도소득세': 'https://www.nts.go.kr/tax/yangdo_2.html',
                '국세청 양도소득세 법령·상담': 'https://www.nts.go.kr/tax/yangdo_2.html',
                '찾기쉬운 생활법령정보': 'https://lnp.nanet.go.kr',
                '대법원 종합법률정보': 'https://glaw.scourt.go.kr',
                '헌법재판소': 'https://www.ccourt.go.kr',
                '행정안전부': 'https://www.mois.go.kr',
                '기획재정부': 'https://www.moef.go.kr'
            };
            
            // 정확한 매칭 먼저 시도
            let url = publicInstitutionMap[siteName];
            
            // 정확한 매칭이 없으면 키워드 매칭 시도 (공공기관만)
            if (!url) {
                if (siteName.includes('국세청')) {
                    if (siteName.includes('양도소득세') || siteName.includes('양도세')) {
                        url = 'https://www.nts.go.kr/tax/yangdo_2.html';
                    } else {
                        url = 'https://www.nts.go.kr';
                    }
                } else if (siteName.includes('국가법령') || siteName.includes('법령정보')) {
                    url = 'https://www.law.go.kr';
                } else if (siteName.includes('생활법령') || siteName.includes('찾기쉬운')) {
                    url = 'https://lnp.nanet.go.kr';
                } else if (siteName.includes('대법원') || siteName.includes('종합법률')) {
                    url = 'https://glaw.scourt.go.kr';
                } else if (siteName.includes('헌법재판소')) {
                    url = 'https://www.ccourt.go.kr';
                } else if (siteName.includes('행정안전부')) {
                    url = 'https://www.mois.go.kr';
                } else if (siteName.includes('기획재정부')) {
                    url = 'https://www.moef.go.kr';
                }
            }
            
            if (url) {
                window.open(url, '_blank');
            } else {
                console.log('찾을 수 없는 공공기관 사이트명:', siteName);
                alert('해당 공공기관의 링크를 찾을 수 없습니다. 사이트명: ' + siteName);
            }
        }

        // CSV 필드 이스케이프 (한글 및 특수문자 안전 처리)
        function escapeCSVField(field) {
            if (!field) return '""';
            
            // 줄바꿈과 따옴표 처리
            let escaped = field.toString()
                .replace(/"/g, '""')  // 따옴표를 두 개로 이스케이프
                .replace(/\r\n/g, ' ')  // 줄바꿈을 공백으로
                .replace(/\n/g, ' ')    // 줄바꿈을 공백으로
                .replace(/\r/g, ' ');   // 줄바꿈을 공백으로
            
            // 쉼표, 따옴표, 줄바꿈이 포함된 경우 따옴표로 감싸기
            if (escaped.includes(',') || escaped.includes('"') || escaped.includes('\n') || escaped.includes('\r')) {
                return `"${escaped}"`;
            }
            
            return escaped;
        }
          </script>
  </body>
  </html>